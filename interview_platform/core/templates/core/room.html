{% extends "core/base.html" %}
{% load static %}

{% block style %}
<style>
    /* Prevent the page from being redirected */
    body {
        overflow: auto;
    }
    
    /* Make the editor and whiteboard fill the available space */
    .editor-container, .whiteboard-container {
        height: 70vh;
    }
    
    #editor {
        height: 100%;
        width: 100%;
        font-family: monospace;
    }
    
    #whiteboard {
        background-color: white;
    }

    body {
        font-family: Consolas, "Courier New", Courier, monospace;
      }

      .editor-container, .whiteboard-container {
        height: auto;  /* Allow the editor container to grow with content */
        flex: 1;
    }

      .editor {
        display: inline-flex;
        gap: 10px;
        font-family: Consolas, "Courier New", Courier, monospace;
        line-height: 21px;
        background-color: transparent;
        border-radius: 2px;
        padding: 20px 10px;
      }
      textarea {
        line-height: 21px;
        overflow-y: hidden;
        padding: 0;
        border: 0;
        background: transparent;
        color: black;
        min-width: 500px;
        min-height: 100%;
        height: 100vh;
        outline: none;
        resize: none;
        font-family: Consolas, "Courier New", Courier, monospace;
        box-sizing: border-box;
      }
      .numbers {
        width: 20px;
        text-align: right;
        margin-right: 10px;
        font-style: italic;
      }

      .numbers span {
        counter-increment: linenumber;
      }

      .numbers span::before {
        content: counter(linenumber);
        display: block;
        color: #506882;
      }

</style>
{% endblock %}

{% block script %}
<script src="{% static 'js/whiteboard.js' %}"></script>
<script src="{% static 'js/room.js' %}"></script>
<script>
    // Pass the room ID to JavaScript
    const roomId = "{{ room }}";
    
    // Initialize the connection when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Room page loaded, initializing room:", roomId);
        
        // Connect to the room
        initRoom(roomId);
        
        // Start the timer on the server (only the first tab will actually set the timer)
        setTimeout(function() {
            console.log("Starting session timer");
            startSessionTimer(60); // 1 minute for testing
        }, 1000); // Longer delay to ensure WebSocket is connected
        
        // Set up the text change handler
        document.getElementById('editor').addEventListener('keyup', function() {
            if (typeof window.onTextChange === 'function') {
                window.onTextChange();
            }
        });
    });
    
    // Prevent navigation away from the page
    window.onbeforeunload = function() {
        return "Leaving this page will end your interview session. Are you sure?";
    };

    const textarea = document.querySelector("textarea");
      const numbers = document.querySelector(".numbers");
      textarea.addEventListener("keyup", (e) => {
        const num = e.target.value.split("\n").length;
        numbers.innerHTML = Array(num).fill("<span></span>").join("");
        
      });
      textarea.addEventListener("keydown", (event) => {
        if (event.key === "Tab") {
          const start = textarea.selectionStart;
          const end = textarea.selectionEnd;

          textarea.value =
            textarea.value.substring(0, start) +
            "\t" +
            textarea.value.substring(end);

          event.preventDefault();
        }
      });

</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>Interview Session: {{ session.title }}</h2>
            <div id="timer" class="alert alert-info">Time remaining: 01:00</div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-md-6 editor-container">
          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h3 class="card-title mb-0 ">Code Editor</h3>
            </div>
            <div class="card-body">
              <div class="editor">
                <div class="numbers">
                  <span></span>
                </div>
                <textarea placeholder="Start here, good luck!"></textarea>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-md-6 whiteboard-container">
          <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
              <h3 class="card-title mb-0">Whiteboard</h3>
            </div>
            <div class="card-body">
              <canvas id="whiteboard" width="600" height="400" style="border:1px solid black;"></canvas>
            </div>
          </div>
        </div>
    </div>
    
    <!-- Hidden input for room ID -->
    <input type="hidden" id="roomId" value="{{ room }}">
</div>
{% endblock %}