{% extends "core/base.html" %}
{% load static %}

{% block style %}
<style>
    /* Prevent the page from being redirected */
    body {
        overflow: hidden;
    }
    
    /* Make the editor and whiteboard fill the available space */
    .editor-container, .whiteboard-container {
        height: 70vh;
    }
    
    #editor {
        height: 100%;
        width: 100%;
        font-family: monospace;
    }
    
    #whiteboard {
        background-color: white;
    }
</style>
{% endblock %}

{% block script %}
<script src="{% static 'js/whiteboard.js' %}"></script>
<script src="{% static 'js/room.js' %}"></script>
<script>
    // Pass the room ID to JavaScript
    const roomId = "{{ room }}";
    
    // Initialize the connection when the page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log("Room page loaded, initializing room:", roomId);
        
        // Connect to the room
        initRoom(roomId);
        
        // Start the timer on the server (only the first tab will actually set the timer)
        // Wait longer for WebSocket to connect
        setTimeout(function() {
            console.log("Checking if WebSocket is ready to start timer");
            if (window.roomSocket && window.roomSocket.readyState === WebSocket.OPEN) {
                console.log("WebSocket is open, starting session timer");
                startSessionTimer(900);
            } else {
                console.log("WebSocket not ready, waiting longer");
                setTimeout(function() {
                    console.log("Trying again to start timer");
                    if (window.roomSocket) {
                        startSessionTimer(900);
                    } else {
                        console.error("Could not start timer: WebSocket not available");
                    }
                }, 3000);
            }
        }, 2000);
        
        // Set up the text change handler
        document.getElementById('editor').addEventListener('keyup', function() {
            if (typeof window.onTextChange === 'function') {
                window.onTextChange();
            }
        });
    });
    
    // Prevent navigation away from the page
    window.onbeforeunload = function() {
        return "Leaving this page will end your interview session. Are you sure?";
    };
</script>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <h2>Interview Session: {{ session.title }}</h2>
            <div id="timer" class="alert alert-info">Time remaining: 01:00</div>
        </div>
    </div>
    
    <div class="row">
        <div class="col-12 col-md-6 editor-container">
            <h3>Code Editor</h3>
            <textarea id="editor" class="form-control"></textarea>
        </div>
        <div class="col-12 col-md-6 whiteboard-container">
            <h3>Whiteboard</h3>
            <canvas id="whiteboard" width="600" height="400" style="border:1px solid black;"></canvas>
            <div class="mt-2">
                <label for="lineWidth">Line Width:</label>
                <input type="range" min="1" max="10" value="5" class="slider" id="lineWidth" onchange="window.setWBLine()">
                
                <label for="colorPicker" class="ms-2">Color:</label>
                <input type="color" id="colorPicker" value="#000000" onchange="window.setWBColor()">
                
                <button class="btn btn-info ms-2" onclick="window.clearWhiteboard()">Clear</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden input for room ID -->
    <input type="hidden" id="roomId" value="{{ room }}">
</div>
{% endblock %}